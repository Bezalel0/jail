local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

-- Your existing script
getgenv().toggled = true -- true & false

getgenv().old = getgenv().old or require(game:GetService("ReplicatedStorage").Module.RayCast).RayIgnoreNonCollideWithIgnoreList

if getgenv().toggled then
    require(game:GetService("ReplicatedStorage").Module.RayCast).RayIgnoreNonCollideWithIgnoreList = function(...)
        local nearestDistance, nearestEnemy = 200, nil
        for i,v in pairs(Players:GetPlayers()) do
            if v.Team ~= LocalPlayer.Team and v.Character and v.Character:FindFirstChild("HumanoidRootPart") then
                if (v.Character.HumanoidRootPart.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude < nearestDistance then
                    nearestDistance, nearestEnemy = (v.Character.HumanoidRootPart.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude, v
                end
            end
        end
        local arg = {getgenv().old(...)}
        if (tostring(getfenv(2).script) == "BulletEmitter" or tostring(getfenv(2).script) == "Taser") and nearestEnemy then
            arg[1] = nearestEnemy.Character.HumanoidRootPart
            arg[2] = nearestEnemy.Character.HumanoidRootPart.Position
        end
        return unpack(arg)
    end
else
    require(game:GetService("ReplicatedStorage").Module.RayCast).RayIgnoreNonCollideWithIgnoreList = getgenv().old
end

-- ESP functionality
local ESP = {}
ESP.Enabled = true

local function CreateESPBox(player)
    local Box = Drawing.new("Square")
    Box.Thickness = 2
    Box.Transparency = 1
    Box.Color = Color3.new(1, 1, 1)
    Box.Visible = false

    local Name = Drawing.new("Text")
    Name.Text = player.Name
    Name.Size = 20
    Name.Color = Color3.new(1, 1, 1)
    Name.Center = true
    Name.Outline = true
    Name.Visible = false

    return {Box = Box, Name = Name}
end

local function UpdateESPBox(player, esp)
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
        esp.Box.Visible = false
        esp.Name.Visible = false
        return
    end

    local RootPart = player.Character.HumanoidRootPart
    local RootPosition, onScreen = Camera:WorldToViewportPoint(RootPart.Position)

    if onScreen and ESP.Enabled then
        local BoxSize = Vector3.new(4, 7, 0)
        local TopLeft = Camera:WorldToViewportPoint((RootPart.CFrame * CFrame.new(-BoxSize.X, BoxSize.Y, 0)).p)
        local BottomRight = Camera:WorldToViewportPoint((RootPart.CFrame * CFrame.new(BoxSize.X, -BoxSize.Y, 0)).p)

        esp.Box.Size = Vector2.new(BottomRight.X - TopLeft.X, BottomRight.Y - TopLeft.Y)
        esp.Box.Position = Vector2.new(RootPosition.X - esp.Box.Size.X / 2, RootPosition.Y - esp.Box.Size.Y / 2)
        esp.Box.Visible = true

        esp.Name.Position = Vector2.new(RootPosition.X, RootPosition.Y - esp.Box.Size.Y / 2 - 15)
        esp.Name.Visible = true

        if player.Team.Name == "Police" then
            esp.Box.Color = Color3.fromRGB(0, 0, 255)
            esp.Name.Color = Color3.fromRGB(0, 0, 255)
        elseif player.Team.Name == "Criminal" then
            esp.Box.Color = Color3.fromRGB(255, 0, 0)
            esp.Name.Color = Color3.fromRGB(255, 0, 0)
        else -- Prisoner
            esp.Box.Color = Color3.fromRGB(255, 165, 0)
            esp.Name.Color = Color3.fromRGB(255, 165, 0)
        end
    else
        esp.Box.Visible = false
        esp.Name.Visible = false
    end
end

local ESPBoxes = {}

for _, player in pairs(Players:GetPlayers()) do
    if player ~= LocalPlayer then
        ESPBoxes[player] = CreateESPBox(player)
    end
end

Players.PlayerAdded:Connect(function(player)
    if player ~= LocalPlayer then
        ESPBoxes[player] = CreateESPBox(player)
    end
end)

Players.PlayerRemoving:Connect(function(player)
    if ESPBoxes[player] then
        ESPBoxes[player].Box:Remove()
        ESPBoxes[player].Name:Remove()
        ESPBoxes[player] = nil
    end
end)

RunService.RenderStepped:Connect(function()
    for player, esp in pairs(ESPBoxes) do
        UpdateESPBox(player, esp)
    end
end)
