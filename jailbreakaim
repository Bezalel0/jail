-- Combined ESP and Aimbot Script for Jailbreak

-- Settings
local MAX_DISTANCE = 1000  -- Increase distance for better visibility
local TOGGLE_AIMBOT = true -- Set to true to enable aimbot
local ESP_REFRESH_INTERVAL = 2 -- Seconds between ESP updates

-- Services
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RayCastModule = require(ReplicatedStorage:WaitForChild("Module"):WaitForChild("RayCast"))

-- Function to create or update an ESP box with player names
local function createOrUpdateESP(character, color)
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if hrp then
        local esp = hrp:FindFirstChild("ESP")
        if not esp then
            esp = Instance.new("BillboardGui")
            esp.Name = "ESP"
            esp.Adornee = hrp
            esp.Size = UDim2.new(0, 200, 0, 200) -- Adjust size to fit player
            esp.StudsOffset = Vector3.new(0, 3, 0) -- Adjusted vertical offset
            esp.AlwaysOnTop = true
            esp.LightInfluence = 0 -- Ensures visibility in all lighting conditions
            esp.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
            esp.Parent = hrp
            
            local frame = Instance.new("Frame")
            frame.Name = "ESPFrame"
            frame.Parent = esp
            frame.BackgroundColor3 = color
            frame.Size = UDim2.new(1, 0, 1, 0)
            frame.BorderSizePixel = 0
            frame.BackgroundTransparency = 0.5 -- Semi-transparent for visibility through walls

            local textLabel = Instance.new("TextLabel")
            textLabel.Name = "NameLabel"
            textLabel.Text = character.Name
            textLabel.Size = UDim2.new(1, 0, 0.2, 0) -- Size for the name label
            textLabel.Position = UDim2.new(0, 0, 1, 0) -- Positioning below the box
            textLabel.BackgroundTransparency = 1 -- Transparent background
            textLabel.TextColor3 = Color3.new(1, 1, 1) -- White text
            textLabel.TextStrokeColor3 = Color3.new(0, 0, 0) -- Black text stroke
            textLabel.TextStrokeTransparency = 0 -- Opaque text stroke for better readability
            textLabel.TextScaled = true
            textLabel.Parent = esp
        else
            -- Update the color if ESP already exists
            esp.ESPFrame.BackgroundColor3 = color
            esp.NameLabel.Text = character.Name -- Update the name label
        end
    end
end

-- Function to apply ESP to all players
local function applyESP()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local color
            local team = player.Team and player.Team.Name

            if team == "Criminals" then
                color = Color3.fromRGB(255, 0, 0) -- Red for criminals
            elseif team == "Cops" then
                color = Color3.fromRGB(0, 0, 255) -- Blue for cops
            elseif team == "Prisoners" then
                color = Color3.fromRGB(255, 165, 0) -- Orange for prisoners
            else
                color = Color3.fromRGB(255, 255, 255) -- White for unrecognized teams
            end

            if color then
                createOrUpdateESP(player.Character, color)
            end
        end
    end
end

-- Function to refresh ESP every ESP_REFRESH_INTERVAL seconds
local function refreshESP()
    while true do
        applyESP()
        wait(ESP_REFRESH_INTERVAL) -- Refresh interval
    end
end

-- Aimbot Implementation
local function aimbot()
    local oldRayIgnoreNonCollideWithIgnoreList = RayCastModule.RayIgnoreNonCollideWithIgnoreList
    if TOGGLE_AIMBOT then
        RayCastModule.RayIgnoreNonCollideWithIgnoreList = function(...)
            local nearestDistance, nearestEnemy = MAX_DISTANCE, nil
            for _, v in pairs(Players:GetPlayers()) do
                if v.Team ~= LocalPlayer.Team and v.Character and v.Character:FindFirstChild("HumanoidRootPart") then
                    local distance = (v.Character.HumanoidRootPart.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
                    if distance < nearestDistance then
                        nearestDistance, nearestEnemy = distance, v
                    end
                end
            end
            local args = {oldRayIgnoreNonCollideWithIgnoreList(...)}
            if nearestEnemy then
                args[1] = nearestEnemy.Character.HumanoidRootPart
                args[2] = nearestEnemy.Character.HumanoidRootPart.Position
            end
            return unpack(args)
        end
    else
        RayCastModule.RayIgnoreNonCollideWithIgnoreList = oldRayIgnoreNonCollideWithIgnoreList
    end
end

-- Run both ESP and Aimbot functionalities
RunService.Heartbeat:Connect(function()
    aimbot()
end)

-- Start ESP refresh loop
coroutine.wrap(refreshESP)()
