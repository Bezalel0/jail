-- Settings
local MAX_DISTANCE = 1000  -- Distance for aimbot targeting
local TOGGLE_AIMBOT = true -- Set to true to enable aimbot
local ESP_REFRESH_INTERVAL = 2 -- Seconds between ESP updates

-- Services
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RayCastModule = require(ReplicatedStorage:WaitForChild("Module"):WaitForChild("RayCast"))

-- Function to create or update an ESP label with player names and team info
local function createOrUpdateESP(character, color)
    local head = character:FindFirstChild("Head")
    if head then
        local espLabel = head:FindFirstChild("ESPLabel")
        if not espLabel then
            espLabel = Instance.new("BillboardGui")
            espLabel.Name = "ESPLabel"
            espLabel.Adornee = head
            espLabel.Size = UDim2.new(0, 150, 0, 50) -- Size adjusted for better mobile visibility
            espLabel.StudsOffset = Vector3.new(0, 2, 0) -- Vertical offset
            espLabel.AlwaysOnTop = true
            espLabel.Parent = head
            
            local textLabel = Instance.new("TextLabel")
            textLabel.Name = "NameLabel"
            textLabel.Size = UDim2.new(1, 0, 1, 0)
            textLabel.BackgroundTransparency = 1
            textLabel.TextColor3 = color
            textLabel.TextStrokeColor3 = Color3.new(0, 0, 0) -- Black text stroke
            textLabel.TextStrokeTransparency = 0.5 -- Semi-transparent stroke for visibility
            textLabel.TextScaled = true
            textLabel.TextStrokeTransparency = 0 -- Opaque text stroke
            textLabel.Parent = espLabel
        end
        -- Update the text and color
        espLabel.NameLabel.Text = character.Name -- Player name
        espLabel.NameLabel.TextColor3 = color
    end
end

-- Function to apply ESP to all players
local function applyESP()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("Head") then
            local color
            local team = player.Team and player.Team.Name

            if team == "Criminals" then
                color = Color3.fromRGB(255, 0, 0) -- Red for criminals
            elseif team == "Cops" then
                color = Color3.fromRGB(0, 0, 255) -- Blue for cops
            elseif team == "Prisoners" then
                color = Color3.fromRGB(255, 165, 0) -- Orange for prisoners
            else
                color = Color3.fromRGB(255, 255, 255) -- White for unrecognized teams
            end

            if color then
                createOrUpdateESP(player.Character, color)
            end
        end
    end
end

-- Function to refresh ESP every ESP_REFRESH_INTERVAL seconds
local function refreshESP()
    while true do
        applyESP()
        wait(ESP_REFRESH_INTERVAL) -- Refresh interval
    end
end

-- Aimbot Implementation
local function aimbot()
    local oldRayIgnoreNonCollideWithIgnoreList = RayCastModule.RayIgnoreNonCollideWithIgnoreList
    if TOGGLE_AIMBOT then
        RayCastModule.RayIgnoreNonCollideWithIgnoreList = function(...)
            local nearestDistance, nearestEnemy = MAX_DISTANCE, nil
            for _, v in pairs(Players:GetPlayers()) do
                if v.Team ~= LocalPlayer.Team and v.Character and v.Character:FindFirstChild("HumanoidRootPart") then
                    local distance = (v.Character.HumanoidRootPart.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
                    if distance < nearestDistance then
                        nearestDistance, nearestEnemy = distance, v
                    end
                end
            end
            local args = {oldRayIgnoreNonCollideWithIgnoreList(...)}
            if nearestEnemy then
                args[1] = nearestEnemy.Character.HumanoidRootPart
                args[2] = nearestEnemy.Character.HumanoidRootPart.Position
            end
            return unpack(args)
        end
    else
        RayCastModule.RayIgnoreNonCollideWithIgnoreList = oldRayIgnoreNonCollideWithIgnoreList
    end
end

-- Run both ESP and Aimbot functionalities
RunService.Heartbeat:Connect(function()
    aimbot()
end)

-- Start ESP refresh loop
coroutine.wrap(refreshESP)()
