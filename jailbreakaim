local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Aimbot code (unchanged)
getgenv().toggled = true --/ true & false
getgenv().old = getgenv().old or require(ReplicatedStorage.Module.RayCast).RayIgnoreNonCollideWithIgnoreList
if getgenv().toggled then
    require(ReplicatedStorage.Module.RayCast).RayIgnoreNonCollideWithIgnoreList = function(...)
        local nearestDistance, nearestEnemy = 600, nil
        for i,v in pairs(Players:GetPlayers()) do
            if v.Team ~= Players.LocalPlayer.Team and v.Character and v.Character:FindFirstChild("HumanoidRootPart") then
                if (v.Character.HumanoidRootPart.Position - Players.LocalPlayer.Character.HumanoidRootPart.Position).Magnitude < nearestDistance then
                    nearestDistance, nearestEnemy = (v.Character.HumanoidRootPart.Position - Players.LocalPlayer.Character.HumanoidRootPart.Position).Magnitude, v
                end
            end
        end
        local arg = {old(...)}
        if (tostring(getfenv(2).script) == "BulletEmitter" or tostring(getfenv(2).script) == "Taser") and nearestEnemy then
            arg[1] = nearestEnemy.Character.HumanoidRootPart
            arg[2] = nearestEnemy.Character.HumanoidRootPart.Position
        end
        return unpack(arg)
    end
else
    require(ReplicatedStorage.Module.RayCast).RayIgnoreNonCollideWithIgnoreList = getgenv().old
end

-- ESP code
local function createESP(player)
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ESP"
    billboard.AlwaysOnTop = true
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 4, 0)
    
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Name = "PlayerName"
    nameLabel.Size = UDim2.new(1, 0, 0.5, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.TextScaled = true
    nameLabel.Font = Enum.Font.SourceSansBold
    nameLabel.Parent = billboard
    
    local teamLabel = Instance.new("TextLabel")
    teamLabel.Name = "TeamName"
    teamLabel.Size = UDim2.new(1, 0, 0.5, 0)
    teamLabel.Position = UDim2.new(0, 0, 0.5, 0)
    teamLabel.BackgroundTransparency = 1
    teamLabel.TextScaled = true
    teamLabel.Font = Enum.Font.SourceSansBold
    teamLabel.Parent = billboard
    
    return billboard
end

local espEnabled = false
local espObjects = {}

local function updateESP()
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= Players.LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local esp = espObjects[player]
            if not esp then
                esp = createESP(player)
                espObjects[player] = esp
            end
            
            esp.Adornee = player.Character.HumanoidRootPart
            esp.Parent = player.Character.HumanoidRootPart
            
            local nameLabel = esp:FindFirstChild("PlayerName")
            local teamLabel = esp:FindFirstChild("TeamName")
            
            if nameLabel and teamLabel then
                nameLabel.Text = player.Name
                teamLabel.Text = player.Team and player.Team.Name or "No Team"
                
                if player.Team then
                    if player.Team.Name == "Police" then
                        nameLabel.TextColor3 = Color3.new(0, 0, 1) -- Blue
                        teamLabel.TextColor3 = Color3.new(0, 0, 1)
                    elseif player.Team.Name == "Criminal" then
                        nameLabel.TextColor3 = Color3.new(1, 0, 0) -- Red
                        teamLabel.TextColor3 = Color3.new(1, 0, 0)
                    elseif player.Team.Name == "Prisoner" then
                        nameLabel.TextColor3 = Color3.new(1, 0.5, 0) -- Orange
                        teamLabel.TextColor3 = Color3.new(1, 0.5, 0)
                    else
                        nameLabel.TextColor3 = Color3.new(1, 1, 1) -- White
                        teamLabel.TextColor3 = Color3.new(1, 1, 1)
                    end
                end
            end
            
            esp.Enabled = espEnabled
        end
    end
end

local function toggleESP()
    espEnabled = not espEnabled
    for _, esp in pairs(espObjects) do
        esp.Enabled = espEnabled
    end
end

RunService.RenderStepped:Connect(updateESP)

UserInputService.InputBegan:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.E then
        toggleESP()
    end
end)

Players.PlayerRemoving:Connect(function(player)
    local esp = espObjects[player]
    if esp then
        esp:Destroy()
        espObjects[player] = nil
    end
end)
