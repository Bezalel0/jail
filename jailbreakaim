local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

-- Your existing script
getgenv().toggled = true -- true & false

getgenv().old = getgenv().old or require(game:GetService("ReplicatedStorage").Module.RayCast).RayIgnoreNonCollideWithIgnoreList

if getgenv().toggled then
    require(game:GetService("ReplicatedStorage").Module.RayCast).RayIgnoreNonCollideWithIgnoreList = function(...)
        local nearestDistance, nearestEnemy = 200, nil
        for i, v in pairs(Players:GetPlayers()) do
            if v.Team ~= LocalPlayer.Team and v.Character and v.Character:FindFirstChild("HumanoidRootPart") then
                if (v.Character.HumanoidRootPart.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude < nearestDistance then
                    nearestDistance, nearestEnemy = (v.Character.HumanoidRootPart.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude, v
                end
            end
        end
        local arg = {getgenv().old(...)}
        if (tostring(getfenv(2).script) == "BulletEmitter" or tostring(getfenv(2).script) == "Taser") and nearestEnemy then
            arg[1] = nearestEnemy.Character.HumanoidRootPart
            arg[2] = nearestEnemy.Character.HumanoidRootPart.Position
        end
        return unpack(arg)
    end
else
    require(game:GetService("ReplicatedStorage").Module.RayCast).RayIgnoreNonCollideWithIgnoreList = getgenv().old
end

-- ESP functionality
local ESP = {}
ESP.Enabled = true

local function CreateESPName(player)
    local Name = Drawing.new("Text")
    Name.Text = player.Name
    Name.Size = 20
    Name.Color = Color3.new(1, 1, 1)
    Name.Center = true
    Name.Outline = true
    Name.Visible = false

    return Name
end

local function UpdateESPName(player, espName)
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
        espName.Visible = false
        return
    end

    local RootPart = player.Character.HumanoidRootPart
    local RootPosition, onScreen = Camera:WorldToViewportPoint(RootPart.Position)

    if onScreen and ESP.Enabled then
        espName.Position = Vector2.new(RootPosition.X, RootPosition.Y - 15)
        espName.Visible = true

        if player.Team.Name == "Police" then
            espName.Color = Color3.fromRGB(0, 0, 255)
        elseif player.Team.Name == "Criminal" then
            espName.Color = Color3.fromRGB(255, 0, 0)
        else -- Prisoner
            espName.Color = Color3.fromRGB(255, 165, 0)
        end
    else
        espName.Visible = false
    end
end

local ESPNames = {}

for _, player in pairs(Players:GetPlayers()) do
    if player ~= LocalPlayer then
        ESPNames[player] = CreateESPName(player)
    end
end

Players.PlayerAdded:Connect(function(player)
    if player ~= LocalPlayer then
        ESPNames[player] = CreateESPName(player)
    end
end)

Players.PlayerRemoving:Connect(function(player)
    if ESPNames[player] then
        ESPNames[player]:Remove()
        ESPNames[player] = nil
    end
end)

local function UpdateAllESP()
    for player, espName in pairs(ESPNames) do
        UpdateESPName(player, espName)
    end
end

local updateInterval = 0.1 -- Update every 0.1 seconds
local lastUpdate = 0

RunService.RenderStepped:Connect(function(deltaTime)
    lastUpdate = lastUpdate + deltaTime
    if lastUpdate >= updateInterval then
        UpdateAllESP()
        lastUpdate = 0
    end
end)
