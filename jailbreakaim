-- Combined ESP (Police only) and Aimbot Functionality

-- ESP Functionality
local ESP = {}
ESP.Enabled = true
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local ESPNames = {}
local MAX_DISTANCE = 10000 -- Increased to cover most of the map
local UPDATE_INTERVAL = 0.1 -- Update ESP every 0.1 seconds

-- Aimbot Functionality
getgenv().toggled = true -- true & false
getgenv().old = getgenv().old or require(game:GetService("ReplicatedStorage").Module.RayCast).RayIgnoreNonCollideWithIgnoreList
local MAX_AIMBOT_DISTANCE = 200 -- max distance is 200 studs

-- ESP Functions
local function CreateESPName(player)
    local Name = Drawing.new("Text")
    Name.Text = player.Name
    Name.Size = 20
    Name.Color = Color3.new(0, 0, 1) -- Blue for Police
    Name.Center = true
    Name.Outline = true
    Name.Visible = false
    return Name
end

local function UpdateESPName(player, espName, rootPart)
    local rootPosition, onScreen = Camera:WorldToViewportPoint(rootPart.Position)
    local distance = (rootPart.Position - Camera.CFrame.Position).Magnitude
    
    if onScreen and ESP.Enabled then
        espName.Position = Vector2.new(rootPosition.X, rootPosition.Y - 15)
        espName.Size = math.clamp(30 - (distance / 100), 10, 30) -- Adjust size based on distance
        espName.Transparency = math.clamp((MAX_DISTANCE - distance) / MAX_DISTANCE, 0.3, 1)
        espName.Visible = true
    else
        espName.Visible = false
    end
end

local function CreateESPForPlayer(player)
    if player ~= LocalPlayer and player.Team and player.Team.Name == "Police" then
        ESPNames[player] = CreateESPName(player)
    end
end

local function RemoveESPForPlayer(player)
    if ESPNames[player] then
        ESPNames[player]:Remove()
        ESPNames[player] = nil
    end
end

-- Initialize ESP
for _, player in ipairs(Players:GetPlayers()) do
    CreateESPForPlayer(player)
end

Players.PlayerAdded:Connect(CreateESPForPlayer)
Players.PlayerRemoving:Connect(RemoveESPForPlayer)

-- ESP Update Function
local lastUpdateTime = 0
local function UpdateESP()
    local currentTime = tick()
    if currentTime - lastUpdateTime < UPDATE_INTERVAL then return end
    lastUpdateTime = currentTime
    for player, espName in pairs(ESPNames) do
        local character = player.Character
        local rootPart = character and character:FindFirstChild("HumanoidRootPart")
        if rootPart and player.Team and player.Team.Name == "Police" then
            UpdateESPName(player, espName, rootPart)
        else
            espName.Visible = false
        end
    end
end

-- Aimbot Function
local function AimbotFunction(...)
    local nearestDistance, nearestEnemy = MAX_AIMBOT_DISTANCE, nil
    for i, v in pairs(Players:GetPlayers()) do
        if v.Team ~= LocalPlayer.Team and v.Character and v.Character:FindFirstChild("HumanoidRootPart") then
            local distance = (v.Character.HumanoidRootPart.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
            if distance < nearestDistance then
                nearestDistance, nearestEnemy = distance, v
            end
        end
    end
    local arg = {getgenv().old(...)}
    if (tostring(getfenv(2).script) == "BulletEmitter" or tostring(getfenv(2).script) == "Taser") and nearestEnemy then
        arg[1] = nearestEnemy.Character.HumanoidRootPart
        arg[2] = nearestEnemy.Character.HumanoidRootPart.Position
    end
    return unpack(arg)
end

-- Apply Aimbot
if getgenv().toggled then
    require(game:GetService("ReplicatedStorage").Module.RayCast).RayIgnoreNonCollideWithIgnoreList = AimbotFunction
else
    require(game:GetService("ReplicatedStorage").Module.RayCast).RayIgnoreNonCollideWithIgnoreList = getgenv().old
end

-- ... (previous code remains the same)

-- Modified CreateESPForPlayer function
local function CreateESPForPlayer(player)
    if player ~= LocalPlayer and player.Team and player.Team.Name == "Police" then
        if not ESPNames[player] then
            ESPNames[player] = CreateESPName(player)
        end
    end
end

-- Modified PlayerAdded connection
Players.PlayerAdded:Connect(function(player)
    player:GetPropertyChangedSignal("Team"):Connect(function()
        CreateESPForPlayer(player)
    end)
    CreateESPForPlayer(player)
end)

-- Additional function to handle team changes
local function HandleTeamChange(player)
    if player.Team and player.Team.Name == "Police" then
        CreateESPForPlayer(player)
    else
        RemoveESPForPlayer(player)
    end
end

-- Set up team change handling for existing players
for _, player in ipairs(Players:GetPlayers()) do
    player:GetPropertyChangedSignal("Team"):Connect(function()
        HandleTeamChange(player)
    end)
    HandleTeamChange(player)
end

-- ... (rest of the code remains the same)
-- Run ESP Update
RunService:BindToRenderStep("ESP", Enum.RenderPriority.Camera.Value, UpdateESP)
