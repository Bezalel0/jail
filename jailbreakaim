local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Aimbot code (unchanged)
getgenv().toggled = true --/ true & false
getgenv().old = getgenv().old or require(ReplicatedStorage.Module.RayCast).RayIgnoreNonCollideWithIgnoreList
if getgenv().toggled then
    require(ReplicatedStorage.Module.RayCast).RayIgnoreNonCollideWithIgnoreList = function(...)
        local nearestDistance, nearestEnemy = 600, nil
        for i,v in pairs(Players:GetPlayers()) do
            if v.Team ~= Players.LocalPlayer.Team and v.Character and v.Character:FindFirstChild("HumanoidRootPart") then
                if (v.Character.HumanoidRootPart.Position - Players.LocalPlayer.Character.HumanoidRootPart.Position).Magnitude < nearestDistance then
                    nearestDistance, nearestEnemy = (v.Character.HumanoidRootPart.Position - Players.LocalPlayer.Character.HumanoidRootPart.Position).Magnitude, v
                end
            end
        end
        local arg = {old(...)}
        if (tostring(getfenv(2).script) == "BulletEmitter" or tostring(getfenv(2).script) == "Taser") and nearestEnemy then
            arg[1] = nearestEnemy.Character.HumanoidRootPart
            arg[2] = nearestEnemy.Character.HumanoidRootPart.Position
        end
        return unpack(arg)
    end
else
    require(ReplicatedStorage.Module.RayCast).RayIgnoreNonCollideWithIgnoreList = getgenv().old
end

-- ESP Code
local espEnabled = false
local espFolderName = "ESP_FOLDER"

local function createESP(player)
    local esp = Drawing.new("Text")
    esp.Visible = false
    esp.Center = true
    esp.Outline = true
    esp.Font = 2
    esp.Size = 13
    esp.Color = Color3.new(1, 1, 1)
    esp.OutlineColor = Color3.new(0, 0, 0)
    return esp
end

local function getTeamColor(player)
    if player.Team then
        if player.Team.Name == "Police" then
            return Color3.new(0, 0, 1) -- Blue
        elseif player.Team.Name == "Criminal" then
            return Color3.new(1, 0, 0) -- Red
        elseif player.Team.Name == "Prisoner" then
            return Color3.new(1, 0.5, 0) -- Orange
        end
    end
    return Color3.new(1, 1, 1) -- White for unknown
end

local espObjects = {}

local function updateESP()
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= Players.LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local esp = espObjects[player]
            if not esp then
                esp = createESP(player)
                espObjects[player] = esp
            end

            if espEnabled then
                local vector, onScreen = workspace.CurrentCamera:WorldToViewportPoint(player.Character.HumanoidRootPart.Position)
                if onScreen then
                    esp.Position = Vector2.new(vector.X, vector.Y)
                    local distance = (player.Character.HumanoidRootPart.Position - Players.LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
                    esp.Text = string.format("%s [%d]", player.Name, math.floor(distance))
                    esp.Color = getTeamColor(player)
                    esp.Visible = true
                else
                    esp.Visible = false
                end
            else
                esp.Visible = false
            end
        end
    end
end

local function toggleESP()
    espEnabled = not espEnabled
    for _, esp in pairs(espObjects) do
        esp.Visible = espEnabled
    end
end

RunService.RenderStepped:Connect(updateESP)

UserInputService.InputBegan:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.E then
        toggleESP()
    end
end)

Players.PlayerRemoving:Connect(function(player)
    local esp = espObjects[player]
    if esp then
        esp:Remove()
        espObjects[player] = nil
    end
end)
